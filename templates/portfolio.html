{% extends "layout.html" %}

{% block content %}
<h2 class="mb-3">Portfolio: {{ portfolio.name }}</h2>
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Summary</h5>
        <p class="mb-1"><strong>Cash Balance:</strong> A${{ '%.2f' % summary.cash_balance }}</p>
        <p class="mb-1"><strong>Portfolio Value:</strong> A${{ '%.2f' % summary.current_value }}</p>
        <p class="mb-1"><strong>Daily P/L:</strong> <span class="{{ 'text-success' if summary.daily_profit >= 0 else 'text-danger' }}">A${{ '%.2f' % summary.daily_profit }}</span></p>
        <p class="mb-0"><strong>Total P/L:</strong> <span class="{{ 'text-success' if summary.total_profit >= 0 else 'text-danger' }}">A${{ '%.2f' % summary.total_profit }}</span></p>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Edit Cash Balance</h5>
        <form class="row g-2" method="POST" action="{{ url_for('update_cash', portfolio_id=portfolio.id) }}">
          <div class="col-sm-6">
            <input type="number" step="0.01" class="form-control" name="cash_balance" value="{{ summary.cash_balance }}" required />
          </div>
          <div class="col-sm-auto">
            <button type="submit" class="btn btn-outline-primary">Update Cash</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-12">
    <h4>Add Holding</h4>
    <form class="row g-3" method="POST" action="{{ url_for('add_holding', portfolio_id=portfolio.id) }}">
      <div class="col-md-3">
        <input type="text" class="form-control" name="ticker" placeholder="Ticker (e.g. BHP.AX)" required />
      </div>
      <div class="col-md-2">
        <input type="number" step="0.0001" class="form-control" name="quantity" placeholder="Quantity" required />
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" name="purchase_price" placeholder="Purchase Price" required />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-success">Add</button>
      </div>
    </form>
  </div>
</div>

<h4 class="mb-3">Open Positions</h4>
{% if holdings %}
<div class="table-responsive">
  <table class="table table-bordered table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>Ticker</th>
        <th>Quantity</th>
        <th>Purchase Price (A$)</th>
        <th>Current Price (A$)</th>
        <th>Position Value (A$)</th>
        <th>Daily P/L (A$)</th>
        <th>Total P/L (A$)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for h in holdings %}
      <tr>
        <td>{{ h.ticker }}</td>
        <td>{{ h.quantity }}</td>
        <td>{{ '%.2f' % h.purchase_price }}</td>
        <td>
          {% if h.current_price is not none %}
          {{ '%.2f' % h.current_price }}
          {% else %}
          N/A
          {% endif %}
        </td>
        <td>{{ '%.2f' % h.value }}</td>
        <td>
          {% if h.profit_daily is not none %}
          <span class="{{ 'text-success' if h.profit_daily >= 0 else 'text-danger' }}">{{ '%.2f' % h.profit_daily }}</span>
          {% else %}
          N/A
          {% endif %}
        </td>
        <td>
          <span class="{{ 'text-success' if h.profit_total >= 0 else 'text-danger' }}">{{ '%.2f' % h.profit_total }}</span>
        </td>
        <td>
          <form method="POST" action="{{ url_for('sell_holding', portfolio_id=portfolio.id, holding_id=h.id) }}" onsubmit="return confirm('Sell {{ h.ticker }}?');">
            <button type="submit" class="btn btn-sm btn-warning">Sell</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>No open positions.</p>
{% endif %}

{% if sold_holdings %}
<h4 class="mt-5">Sold Positions</h4>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-light">
      <tr>
        <th>Ticker</th>
        <th>Quantity</th>
        <th>Purchase Price</th>
        <th>Purchase Date</th>
      </tr>
    </thead>
    <tbody>
      {% for sh in sold_holdings %}
      <tr>
        <td>{{ sh.ticker }}</td>
        <td>{{ sh.quantity }}</td>
        <td>{{ '%.2f' % sh.purchase_price }}</td>
        <td>{{ sh.purchase_date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>
{% endblock %}